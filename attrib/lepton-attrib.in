#!/usr/bin/env sh
export GUILE_LOAD_COMPILED_PATH="@ccachedir@:${GUILE_LOAD_COMPILED_PATH}"
exec @GUILE@ -s "$0" "$@"
!#

;;; Lepton EDA attribute editor
;;; Copyright (C) 2003-2010 Stuart D. Brorson.
;;; Copyright (C) 2005-2016 gEDA Contributors
;;; Copyright (C) 2017-2020 Lepton EDA Contributors
;;;
;;; This program is free software; you can redistribute it and/or modify
;;; it under the terms of the GNU General Public License as published by
;;; the Free Software Foundation; either version 2 of the License, or
;;; (at your option) any later version.
;;;
;;; This program is distributed in the hope that it will be useful,
;;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;;; GNU General Public License for more details.
;;;
;;; You should have received a copy of the GNU General Public License
;;; along with this program; if not, write to the Free Software
;;; Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA


(use-modules (system foreign)
             (ice-9 match)
             (ice-9 getopt-long))

;;; Load and initialize liblepton library.
(load-extension (or (getenv "LIBLEPTON") "@libdir@/liblepton")
                "liblepton_init")

(define attrib-main
       (pointer->procedure void
                           (dynamic-func "gattrib_main" (dynamic-link "libleptonattrib"))
                           (list '* int '*)))

;;; Localization.
(define %textdomain "lepton-attrib")
(bindtextdomain %textdomain "@localedir@")
(textdomain %textdomain)
(bind-textdomain-codeset "lepton-attrib" "UTF-8")
(setlocale LC_ALL "")
(setlocale LC_NUMERIC "C")



(primitive-eval '(use-modules (lepton log)
                              (lepton version)))

(define* (lepton-attrib-version )
  "Print lepton-attrib version."
  (define (version-msg . args)
    (apply format #f "Lepton EDA/lepton-attrib ~A~A.~A (git: ~A)\n" args))

  (match (lepton-version)
    ((prepend dotted date commit bugs url msg)
     (log! 'message (version-msg prepend dotted date (string-take commit 7))))))


(define g-slist-append
  (pointer->procedure
   '*
   (dynamic-func "g_slist_append" (dynamic-link "libglib-2.0"))
   (list '* '*)))

(define (list->gslist ls)
  (let loop ((ls ls)
             (gslist %null-pointer))
    (if (null? ls)
        gslist
        (loop (cdr ls)
              (g-slist-append gslist (string->pointer (car ls)))))))

;;; Init logging.
(init-log "attrib")
(lepton-attrib-version)


(let* ((option-spec '((help (single-char #\h))
                      (quiet (single-char #\q))
                      (verbose (single-char #\v))
                      (version (single-char #\V))))

       (options (getopt-long (program-arguments) option-spec))
       (files (option-ref options '() '())))

  ;; FIXME: check that files exist (f_normalize_filename() in the
  ;; original code).
  (attrib-main (list->gslist files) 0 %null-pointer))
